---
title: 前端调用摄像头
date: 2016-07-20 21:04:05
tags:
---
<style type="text/css">
    .vd-box .video, .vd-box .canvas {
        /*width:640px;*/
        /*height:480px;*/
    }
</style>
<section class="vd-box">
    <video class="video" width="320" height="240" autoplay></video>
    <canvas class="canvas" width="320" height="240" id="canvas"></canvas>
    <canvas id="canvas-for-diff" width="320" height="240"></canvas>
</section>
<script type="text/javascript">
    'use strict'
    var video = document.querySelector('video')
    var canvas = document.querySelector('#canvas')
    var canvasForDiff = document.querySelector('#canvas-for-diff')

    navigator.webkitGetUserMedia({
        video: true
    },success,error);

    function success(stream){
        video.src = window.URL.createObjectURL(stream)
        video.play();
    }

    function error(err){
        console.log('video err' + err)
    }

    var context = canvas.getContext('2d')
    var diffctx = canvasForDiff.getContext('2d')
    diffctx.globalCompositeOperation = 'difference'
    var preFrame,
        curFrame,
        diffFrame;
    
    function captureAndSaveFrame () {
        console.log(context);
        preFrame = curFrame;
        context.drawImage(video,0,0,320,240);
        curFrame = canvas.toDataURL();
    }

    function drawImg(src,ctx){
        ctx = ctx || diffctx;
        var img = new Image();
        img.src = src;
        ctx.drawImage(img,0,0,320,240)
    }

    function renderDiff() {
        if(!preFrame||!curFrame) return;
        diffctx.clearRect(0,0,320,240)
        drawImg(preFrame);
        drawImg(curFrame);
        diffFrame = diffctx.getImageData(0,0,320,240)
        //console.log(diffFrame)
    }

    //计算差异
    function calcDiff(){
        if(!diffFrame) return 0;
        var cache = calcDiff,
            count = 0;
        cache.total = cache.total || 0; //整个画布都是白色时所有像素的值的总和
        for (var i = 0, l = diffFrame.width * diffFrame.height * 4; i < l; i += 4) {
            count += diffFrame.data[i] + diffFrame.data[i + 1] + diffFrame.data[i + 2];
            if(!cache.isLoopEver){  //只需在第一次循环里执行
                cache.total += 255 * 3;   //单个白色像素值
            }
        }
        cache.isLoopEver = true;
        count *= 3;  //亮度放大
        //返回“差异画布高亮部分像素总值”占“画布全亮情况像素总值”的比例
        return Number(count/cache.total).toFixed(2);
    }

    function timer(delta){
        setTimeout(function(){
            captureAndSaveFrame();
            renderDiff()
            timer(delta)
            setTimeout(function(){
                console.log(calcDiff())
            },10)
        },delta || 5000)
    }

    timer();
</script>

<a href="http://www.cnblogs.com/vajoy/p/5656439.html">来看看机智的前端童鞋怎么防盗</a>